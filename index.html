<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zmanim Mobile v8</title>
    <style>
        :root { --primary: #2c5282; --bg: #f7fafc; --card: #ffffff; --border: #e2e8f0; --text: #2d3748; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; padding-bottom: 40px; }
        
        /* HEADER */
        .sticky-header { background: #fff; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding: 10px 15px; border-bottom: 1px solid var(--border); }
        .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .app-title { font-size: 18px; font-weight: 800; color: var(--primary); margin: 0; }
        .loc-btn { font-size: 12px; color: #4a5568; background: #edf2f7; padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border); font-weight: 600; cursor: pointer; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; gap: 4px; }
        .loc-btn::before { content: "üìç"; font-size: 10px; }
        
        /* DATE NAV */
        .date-nav { display: flex; align-items: center; justify-content: space-between; background: #f1f5f9; border-radius: 8px; padding: 4px; }
        .nav-btn { width: 36px; height: 36px; border: none; background: #fff; border-radius: 6px; font-size: 18px; color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: pointer; }
        .date-display { text-align: center; line-height: 1.2; flex-grow: 1; }
        .civ-date { font-size: 14px; font-weight: 700; display: block; }
        .heb-date { font-size: 12px; color: #718096; display: block; }

        /* INFO BAR */
        .info-bar { display: flex; gap: 10px; padding: 15px 15px 0 15px; }
        .info-pill { flex: 1; background: #fff; border: 1px solid var(--border); padding: 8px; border-radius: 8px; text-align: center; font-size: 12px; font-weight: 600; color: #4a5568; }
        .info-pill span { display: block; font-size: 10px; color: #a0aec0; text-transform: uppercase; margin-bottom: 2px; }
        .special-pill { color: #c53030; background: #fff5f5; border-color: #fed7d7; }

        /* ZMANIM LIST */
        .zmanim-list { list-style: none; padding: 15px; margin: 0; display: flex; flex-direction: column; gap: 10px; }
        .zman-card { background: var(--card); border-radius: 12px; padding: 12px 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .zman-left { display: flex; flex-direction: column; gap: 2px; }
        .zman-label { font-size: 14px; font-weight: 700; color: #2d3748; }
        .zman-desc { font-size: 11px; color: #718096; }
        .zman-right { text-align: right; display: flex; flex-direction: column; align-items: flex-end; }
        .zman-time { font-size: 20px; font-weight: 700; color: var(--primary); font-family: "SF Mono", monospace; letter-spacing: -0.5px; line-height: 1; }
        .zman-time .sec { font-size: 12px; color: #a0aec0; }
        .sub-label { font-size: 10px; color: #a0aec0; margin-top: 2px; }
        
        .card-select { display: block; margin-top: 4px; font-size: 10px; background: #edf2f7; border: none; padding: 2px 6px; border-radius: 4px; color: #4a5568; font-weight: 600; appearance: none; }

        /* GLOSSARY & FOOTER */
        .glossary-section { padding: 0 15px; }
        details { background: #fff; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; overflow: hidden; }
        summary { padding: 12px; font-size: 14px; font-weight: 600; background: #f8fafc; cursor: pointer; list-style: none; display: flex; justify-content: space-between; align-items: center; outline: none; }
        .glossary-content { padding: 15px; font-size: 13px; line-height: 1.5; color: #4a5568; border-top: 1px solid var(--border); }
        .glossary-content strong { color: var(--primary); display: block; margin-top: 8px; }
        .glossary-content strong:first-child { margin-top: 0; }
        
        .disclaimer { text-align: center; font-size: 11px; color: #a0aec0; padding: 20px 15px; margin-top: 20px; border-top: 1px solid var(--border); line-height: 1.5; }
        .disclaimer a { color: var(--primary); text-decoration: none; font-weight: 600; }

        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-card { background: #fff; width: 90%; max-width: 400px; padding: 20px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-height: 80vh; display: flex; flex-direction: column; }
        .modal-card h2 { margin-top: 0; font-size: 18px; margin-bottom: 15px; }
        .modal-input { width: 100%; padding: 12px; border: 1px solid #cbd5e0; border-radius: 8px; font-size: 16px; margin-bottom: 10px; }
        .modal-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 5px; }
        .gps-btn { background: #48bb78; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .close-btn { background: transparent; color: #718096; margin-top: 5px; }
        
        #searchResults { overflow-y: auto; margin-top: 10px; flex-grow: 1; border-top: 1px solid #eee; max-height: 300px; }
        .city-result { padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; text-align: left; background: none; width: 100%; display: flex; flex-direction: column; align-items: flex-start; }
        .city-result:hover { background: #f7fafc; }
        .city-main { font-weight: 700; font-size: 14px; color: #2d3748; }
        .city-sub { font-size: 12px; color: #718096; margin-top: 2px; }

        @media print { .sticky-header, .info-bar, .modal { display: none; } }
    </style>
</head>
<body>

<div class="sticky-header">
    <div class="top-row">
        <h1 class="app-title">Zmanim Daily</h1>
        <button class="loc-btn" onclick="openLocModal()" id="locBtn">Lakewood, NJ</button>
    </div>
    
    <div class="date-nav">
        <button class="nav-btn" onclick="shiftDate(-1)">&#8249;</button>
        <div class="date-display" onclick="openDateModal()">
            <span class="civ-date" id="displayCiv"></span>
            <span class="heb-date" id="displayHeb"></span>
        </div>
        <button class="nav-btn" onclick="shiftDate(1)">&#8250;</button>
    </div>
</div>

<div class="info-bar">
    <div class="info-pill">
        <span>Day</span>
        <div id="dayName"></div>
    </div>
    <div class="info-pill">
        <span>Daf Yomi</span>
        <div id="dafName"></div>
    </div>
</div>
<div id="specialDayBar" style="padding: 10px 15px 0 15px; display: none;">
    <div class="info-pill special-pill" id="specialDayText"></div>
</div>

<ul class="zmanim-list" id="zmanimList"></ul>

<h3 style="padding: 0 15px; margin: 20px 0 10px 0; color: #718096; font-size: 12px; text-transform: uppercase;">Dictionary & Settings</h3>
<div class="glossary-section" id="glossaryList"></div>

<div class="disclaimer">
    This project uses algorithms based on the <a href="https://kosherjava.com" target="_blank">KosherJava</a> library.<br>
    We do not take responsibility for Halachic accuracy. Use at your own risk.
</div>

<div class="modal" id="locModal">
    <div class="modal-card">
        <h2>Find City</h2>
        <button class="modal-btn gps-btn" onclick="getUserLocation()">üìç Use My Current Location</button>
        
        <div style="margin: 15px 0; border-bottom: 1px solid #eee;"></div>
        
        <label style="font-size:12px; color:#718096; font-weight:700;">SEARCH:</label>
        <div style="display:flex; gap:5px; margin-top:5px;">
            <input type="text" id="citySearchInput" class="modal-input" placeholder="City (e.g. Marlboro, NJ)" style="margin:0;">
            <button class="modal-btn" onclick="searchCity()" style="width:auto; margin:0; background:#3182ce;">Go</button>
        </div>
        
        <div style="margin: 15px 0; border-bottom: 1px solid #eee;"></div>
        
        <label style="font-size:12px; color:#718096; font-weight:700;">SAVED:</label>
        <select id="citySelect" class="modal-input" style="margin-top:5px;" onchange="loadPreset()">
            <option value="" disabled selected>Select a city...</option>
            <option value="40.096,-74.222,America/New_York,30">Lakewood, NJ</option>
            <option value="40.626,-73.955,America/New_York,15">Brooklyn, NY</option>
            <option value="41.116,-74.066,America/New_York,160">Monsey, NY</option>
            <option value="25.790,-80.130,America/New_York,2">Miami, FL</option>
            <option value="31.778,35.225,Asia/Jerusalem,800">Jerusalem, Israel</option>
            <option value="51.507,-0.127,Europe/London,11">London, UK</option>
            <option value="19.076,72.877,Asia/Kolkata,14">Mumbai, India</option>
        </select>

        <div id="searchResults"></div>
        <button class="modal-btn close-btn" onclick="closeLocModal()">Close</button>
    </div>
</div>

<div class="modal" id="dateModal">
    <div class="modal-card">
        <h2>Jump to Date</h2>
        <input type="date" id="datePicker" class="modal-input">
        <button class="modal-btn" onclick="setDateFromPicker()">Go</button>
        <button class="modal-btn" style="background:#48bb78; margin-top:10px;" onclick="goToday()">Go to Today</button>
        <button class="modal-btn close-btn" onclick="document.getElementById('dateModal').classList.remove('active')">Cancel</button>
    </div>
</div>

<script>
    // --- STATE ---
    let currentDate = new Date();
    // Default location: Lakewood
    let loc = { lat: 40.096, lng: -74.222, elev: 30, tz: 'America/New_York', name: 'Lakewood, NJ' };
    
    // Default Zmanim Options
    const opts = { alot:'16.1', mish:'10.2', sunrise:'elev', shema:'gra', tefila:'gra', mincha:'strict', plag:'gra', candles:'18', tzais:'8.5', shaa:'gra', sunset:'elev' };

    // --- ENGINES ---
    const DafEngine = {
        masechtot: [{n:"Berachos",p:63},{n:"Shabbos",p:156},{n:"Eruvin",p:104},{n:"Pesachim",p:120},{n:"Shekalim",p:21},{n:"Yoma",p:87},{n:"Sukkah",p:55},{n:"Beitzah",p:39},{n:"Rosh Hashana",p:34},{n:"Taanis",p:30},{n:"Megillah",p:31},{n:"Moed Katan",p:28},{n:"Chagigah",p:26},{n:"Yevamos",p:121},{n:"Kesubos",p:111},{n:"Nedarim",p:90},{n:"Nazir",p:65},{n:"Sotah",p:48},{n:"Gittin",p:89},{n:"Kiddushin",p:81},{n:"Bava Kamma",p:118},{n:"Bava Metzia",p:118},{n:"Bava Basra",p:175},{n:"Sanhedrin",p:112},{n:"Makkos",p:23},{n:"Shevuos",p:48},{n:"Avodah Zarah",p:75},{n:"Horayos",p:13},{n:"Zevachim",p:119},{n:"Menachos",p:109},{n:"Chullin",p:141},{n:"Bechoros",p:60},{n:"Arachin",p:33},{n:"Temurah",p:33},{n:"Kerisus",p:27},{n:"Meilah",p:21},{n:"Kinnim",p:4},{n:"Tamid",p:9},{n:"Middos",p:4},{n:"Niddah",p:72}],
        get: (date) => {
            const start = new Date(2020, 0, 5); const diff = Math.floor((date - start) / 86400000); if(diff < 0) return "";
            let count = diff; for(let m of DafEngine.masechtot) { if(count < m.p) return `${m.n} ${count + 2}`; count -= m.p; } return "";
        }
    };

    const HebCal = {
        mapMonth: (mStr) => {
            const map = { "Tishri":"Tishrei", "Cheshvan":"Cheshvan", "Kislev":"Kislev", "Tevet":"Teves", "Shevat":"Shevat", "Adar":"Adar", "Adar I":"Adar I", "Adar II":"Adar II", "Nisan":"Nisan", "Iyar":"Iyar", "Sivan":"Sivan", "Tamuz":"Tamuz", "Av":"Av", "Elul":"Elul" };
            return map[mStr] || mStr;
        },
        getHebrewStr: (date) => {
            const f = new Intl.DateTimeFormat('en-US-u-ca-hebrew', { day: 'numeric', month: 'long', year: 'numeric' });
            const p = f.formatToParts(date);
            return `${p.find(x=>x.type==='day').value} ${HebCal.mapMonth(p.find(x=>x.type==='month').value)} ${p.find(x=>x.type==='year').value.split(' ')[0]}`;
        },
        getStatus: (date) => {
            const f = new Intl.DateTimeFormat('en-US-u-ca-hebrew', { day: 'numeric', month: 'long' });
            const p = f.formatToParts(date);
            const d = parseInt(p.find(x=>x.type==='day').value);
            const m = HebCal.mapMonth(p.find(x=>x.type==='month').value);
            const dayOfWeek = date.getDay();
            let st = { isFri: dayOfWeek===5, isShab: dayOfWeek===6, name: null, isErev: false };
            if(d===1 || d===30) st.name = "Rosh Chodesh";
            if(m==='Nisan') { if(d==14) st.name="Erev Pesach"; if(d>=15 && d<=22) st.name=`Pesach Day ${d-14}`; }
            else if(m==='Iyar' && d==18) st.name="Lag BaOmer";
            else if(m==='Sivan') { if(d==5) st.name="Erev Shavuos"; if(d>=6 && d<=7) st.name=`Shavuos Day ${d-5}`; }
            else if(m==='Tamuz' && d==17) st.name="Fast 17 Tamuz";
            else if(m==='Av' && d==9) st.name="Tisha B'Av";
            else if(m==='Elul' && d==29) st.name="Erev R. Hashana";
            else if(m==='Tishrei') {
                if(d<=2) st.name=`Rosh Hashana ${d}`; if(d==3) st.name="Tzom Gedalia"; if(d==9) st.name="Erev YK";
                if(d==10) st.name="Yom Kippur"; if(d==14) st.name="Erev Succos"; if(d>=15 && d<=21) st.name=`Succos Day ${d-14}`;
                if(d==22) st.name="Shmini Atzeres"; if(d==23) st.name="Simchas Torah";
            }
            else if(m==='Kislev' && d>=25) st.name=`Chanukah Day ${d-24}`;
            else if(m==='Teves') { if(d<=3 && !st.name) st.name="Chanukah"; if(d==10) st.name="Asara B'Teves"; }
            else if(m==='Shevat') { if(d==15) st.name="Tu B'Shevat"; }
            else if(m.includes('Adar')) { if(d==13) st.name="Taanis Esther"; if(d==14) st.name="Purim"; }
            if(st.name === "Regular Day" && st.isShab) st.name = "Shabbos";
            if(st.name && st.name.includes("Rosh Chodesh") && st.name.length > 12) st.name = "R.C. / " + st.name.replace("Rosh Chodesh","");
            return st;
        }
    };

    const Solar = {
        rad: d => d * (Math.PI/180), deg: r => r * (180/Math.PI),
        // Robust Solar Calc (NOAA based) handling all longitudes
        calc: (date, lat, lng, elev) => {
            // JD for noon at given date
            // Note: We need to find the JD that corresponds to "Noon" on this date *at this longitude*
            // A simple JD calc gives noon UTC.
            // Adjustment for Longitude: 1 degree = 4 minutes.
            const msPerDay = 86400000;
            // Get UTC timestamp of the start of the day
            const startOfDay = Date.UTC(date.getFullYear(), date.getMonth(), date.getDate());
            
            // Calculate approximate Noon JD for this location
            const JD_approx = (startOfDay / msPerDay) + 2440587.5 - (lng / 360);
            
            // Solar Math
            const D = JD_approx - 2451545.0;
            const q = (280.459 + 0.98564736 * D) % 360;
            const g = (357.529 + 0.98560028 * D) % 360;
            const L = (q + 1.915 * Math.sin(Solar.rad(g)) + 0.020 * Math.sin(Solar.rad(2 * g))) % 360;
            const e = 23.439 - 0.00000036 * D;
            const sinDec = Math.sin(Solar.rad(e)) * Math.sin(Solar.rad(L));
            const cosDec = Math.cos(Math.asin(sinDec));
            const RA = Math.atan2(Math.cos(Solar.rad(e)) * Math.sin(Solar.rad(L)), Math.cos(Solar.rad(L)));
            
            const n = Math.round(D - lng/360);
            const J_star = 2451545.0 + 0.0009 + -lng/360 + n;
            const M = (357.5291 + 0.98560028 * (J_star - 2451545)) % 360;
            const C = (1.9148 * Math.sin(Solar.rad(M)) + 0.0200 * Math.sin(Solar.rad(2 * M)));
            const lam = (M + C + 102.9372 + 180) % 360;
            const J_transit = J_star + 0.0053 * Math.sin(Solar.rad(M)) - 0.0069 * Math.sin(Solar.rad(2 * lam));
            
            const noonMs = (J_transit - 2440587.5) * 86400000;
            
            const getEvent = (zenith) => {
                 const cosH = (Math.cos(Solar.rad(zenith)) - sinDec * Math.sin(Solar.rad(lat))) / (cosDec * Math.cos(Solar.rad(lat)));
                 if(cosH > 1 || cosH < -1) return null;
                 const H = Solar.deg(Math.acos(cosH));
                 const delta = (H / 360) * 86400000;
                 return { rise: noonMs - delta, set: noonMs + delta };
            };
            const zElev = 90.833 + (0.0293 * Math.sqrt(elev));
            return {
                noon: noonMs,
                alot16: getEvent(90+16.1).rise,
                mish10: getEvent(90+10.2).rise, mish11: getEvent(90+11).rise, mish115: getEvent(90+11.5).rise,
                sunLevel: getEvent(90.833), sunElev: getEvent(zElev),
                tzais85: getEvent(90+8.5).set, tzais16: getEvent(90+16.1).set
            };
        }
    };

    // --- RENDER LOGIC ---
    const zmanimConfig = [
        { id: "alot", label: "Alos Hashachar", desc: "Dawn. Beginning of fasts.", opts: [['16.1','16.1¬∞'],['72','72m'],['90','90m']] },
        { id: "mish", label: "Misheyakir", desc: "Earliest Talis & Tefillin.", opts: [['10.2','10.2¬∞'],['11','11¬∞'],['11.5','11.5¬∞']] },
        { id: "sunrise", label: "Netz Hachama", desc: "Sunrise.", opts: [['elev','Visual (Elev)'],['level','Sea Level']] },
        { id: "shema", label: "Sof Zman Shema", desc: "Latest Shema.", opts: [['gra','Gra'],['mga16','MGA 16'],['mga72','MGA 72'],['mga90','MGA 90']] },
        { id: "tefila", label: "Sof Zman Tefila", desc: "Latest Shacharis.", opts: [['gra','Gra'],['mga16','MGA 16'],['mga72','MGA 72'],['mga90','MGA 90']] },
        { id: "chatzos", label: "Chatzos Hayom", desc: "Midday (Solar Noon)." },
        { id: "mincha", label: "Mincha Gedola", desc: "Earliest Mincha.", opts: [['strict','Strict'],['fix30','30m'],['gra','Gra'],['mga','MGA']] },
        { id: "plag", label: "Plag Hamincha", desc: "1.25h before night.", opts: [['gra','Gra'],['mga','MGA']] },
        { id: "candles", label: "Candle Lighting", desc: "Friday Lighting.", opts: [['18','18m'],['22','22m'],['40','40m']] },
        { id: "sunset", label: "Shkia", desc: "Sunset.", opts: [['elev','Visual (Elev)'],['level','Sea Level']] },
        { id: "tzais", label: "Tzais / Motzaei", desc: "Nightfall.", opts: [['8.5','8.5¬∞'],['42','42m'],['50','50m'],['60','60m'],['72','72m']] },
        { id: "shaa", label: "Shaa Zmanis", desc: "Length of 1 Halachic Hour.", opts: [['gra','Gra'],['mga','MGA']] }
    ];

    // --- SEARCH LOGIC ---
    // Helper to check for Jerusalem
    function checkJerusalem(name) {
        if(name.toLowerCase().includes("jerusalem") || name.toLowerCase().includes("yerushalayim")) {
            opts.candles = '40';
        } else {
            opts.candles = '18';
        }
    }

    function loadPreset() {
        const val = document.getElementById('citySelect').value;
        const [lat, lng, tz, elev] = val.split(',');
        const name = document.getElementById('citySelect').options[document.getElementById('citySelect').selectedIndex].text;
        
        loc = { lat: parseFloat(lat), lng: parseFloat(lng), tz, elev: parseInt(elev), name };
        checkJerusalem(name);
        
        // Force refresh candle dropdown
        const cSelect = document.querySelector(`select[onchange="changeOption('candles', this.value)"]`);
        if(cSelect) cSelect.value = opts.candles;

        document.getElementById('locBtn').innerText = `${loc.name} (${loc.elev}m)`;
        closeLocModal();
        render();
    }

    async function searchCity() {
        const query = document.getElementById('citySearchInput').value;
        const resultDiv = document.getElementById('searchResults');
        if(!query) return;
        
        resultDiv.innerHTML = '<div style="padding:10px; color:#718096;">Searching...</div>';
        
        let parts = query.split(/,| /).filter(s => s.trim() !== "");
        let cityName = parts[0];
        let filterRegion = parts.length > 1 ? parts.slice(1).join(" ").toLowerCase() : "";

        try {
            const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(cityName)}&count=20&language=en&format=json`);
            const data = await res.json();
            
            if(!data.results || data.results.length === 0) {
                resultDiv.innerHTML = '<div style="padding:10px; color:red;">No cities found.</div>';
                return;
            }
            
            let filteredResults = data.results;
            // Exclude "East Jerusalem, PS"
            filteredResults = filteredResults.filter(r => !(r.name === "East Jerusalem" && r.country_code === "PS"));

            if(filterRegion) {
                filteredResults = filteredResults.filter(r => {
                    const admin = (r.admin1 || "").toLowerCase();
                    const country = (r.country || "").toLowerCase();
                    const code = (r.country_code || "").toLowerCase();
                    return admin.includes(filterRegion) || country.includes(filterRegion) || code === filterRegion;
                });
                if(filteredResults.length === 0) filteredResults = data.results;
            }

            let html = '';
            filteredResults.forEach(city => {
                const admin = city.admin1 ? city.admin1 + ', ' : '';
                const country = city.country || '';
                const name = city.name;
                html += `<button class="city-result" onclick="selectCity(${city.latitude}, ${city.longitude}, '${name}, ${city.admin1_code || city.country_code}', '${city.timezone}')">
                    <span class="city-main">${name}</span>
                    <span class="city-sub">${admin}${country}</span>
                </button>`;
            });
            resultDiv.innerHTML = html;
            
        } catch(e) {
            resultDiv.innerHTML = '<div style="padding:10px; color:red;">Error fetching data.</div>';
        }
    }

    async function selectCity(lat, lng, name, suffix, timezone) {
        try {
            const elevRes = await fetch(`https://api.open-meteo.com/v1/elevation?latitude=${lat}&longitude=${lng}`);
            const elevData = await elevRes.json();
            const elev = elevData.elevation ? Math.round(elevData.elevation[0]) : 0;
            
            const fullName = `${name}, ${suffix}`;
            loc = { lat, lng, elev, tz: timezone, name: fullName };
            checkJerusalem(name);

            document.getElementById('locBtn').innerText = `${loc.name} (${loc.elev}m)`;
            closeLocModal();
            render();
        } catch(e) { alert("Could not get elevation."); }
    }

    function getUserLocation() {
        if(!navigator.geolocation) { alert("Geolocation not supported."); return; }
        document.querySelector('.gps-btn').innerText = "Locating...";
        
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            try {
                const revRes = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&zoom=10`);
                const revData = await revRes.json();
                const city = revData.address.city || revData.address.town || revData.address.village || "My Location";
                const region = revData.address.state_code || revData.address.country_code.toUpperCase();
                const displayName = `${city}, ${region}`;

                const elevRes = await fetch(`https://api.open-meteo.com/v1/elevation?latitude=${lat}&longitude=${lng}`);
                const elevData = await elevRes.json();
                const elev = elevData.elevation ? Math.round(elevData.elevation[0]) : 0;
                const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
                
                loc = { lat, lng, elev, tz, name: displayName };
                checkJerusalem(city);

                document.getElementById('locBtn').innerText = `${displayName} (${elev}m)`;
                document.querySelector('.gps-btn').innerText = "üìç Use My Current Location";
                closeLocModal();
                render();
            } catch(e) { alert("Error details."); }
        }, (err) => { alert("Location denied."); });
    }

    // --- RENDER ---
    function render() {
        // Ensure input date is treated as local date for calculation context
        const iso = currentDate.toLocaleDateString("en-CA"); // YYYY-MM-DD
        const data = Solar.calc(currentDate, loc.lat, loc.lng, loc.elev);
        const status = HebCal.getStatus(currentDate);
        
        document.getElementById('displayCiv').innerText = currentDate.toLocaleDateString('en-US', {weekday:'short', month:'short', day:'numeric', year:'numeric'});
        document.getElementById('displayHeb').innerText = HebCal.getHebrewStr(currentDate);
        document.getElementById('dayName').innerText = currentDate.toLocaleDateString('en-US', {weekday:'long'});
        document.getElementById('dafName').innerText = DafEngine.get(currentDate);
        
        const sb = document.getElementById('specialDayBar');
        if(status.name && status.name !== "Regular Day" && status.name !== "Shabbos") {
            sb.style.display = "block";
            document.getElementById('specialDayText').innerText = status.name;
        } else { sb.style.display = "none"; }

        const fmt = (ms) => {
            if(!ms) return "--:--";
            const d = new Date(ms);
            return `${d.toLocaleTimeString('en-US', {hour:'numeric',minute:'2-digit', timeZone:loc.tz})}<span class="sec">${d.toLocaleTimeString('en-US',{second:'2-digit',timeZone:loc.tz})}</span>`;
        };
        const mins = m => m*60000;
        const rise = (opts.sunrise==='elev') ? data.sunElev.rise : data.sunLevel.rise;
        const set = (opts.sunrise==='elev') ? data.sunElev.set : data.sunLevel.set;
        const setShkia = (opts.sunset==='elev') ? data.sunElev.set : data.sunLevel.set;
        
        let html = "";
        zmanimConfig.forEach(z => {
            let val = "";
            let sKey = opts[z.id];
            let sub = "";

            if(z.id === "alot") val = fmt(sKey==='16.1' ? data.alot16 : rise - mins(parseInt(sKey)));
            if(z.id === "mish") val = fmt(sKey==='10.2' ? data.mish10 : (sKey==='11' ? data.mish11 : data.mish115));
            if(z.id === "sunrise") val = fmt(rise);
            if(z.id === "chatzos") val = fmt(data.noon);
            if(z.id === "sunset") val = fmt(setShkia);
            if(z.id === "shema" || z.id === "tefila") {
                let factor = z.id==="shema"?3:4;
                let s=rise-mins(72), e=set+mins(72);
                if(sKey==='mga16') { s=data.alot16; e=data.tzais16; }
                if(sKey==='mga90') { s=rise-mins(90); e=set+mins(90); }
                val = fmt(sKey==='gra' ? rise + ((set-rise)/12)*factor : s + ((e-s)/12)*factor);
            }
            if(z.id === "mincha") {
                let m30=data.noon+mins(30); let mGra=rise+((set-rise)/12)*6.5; let mMga=data.alot16+((data.tzais16-data.alot16)/12)*6.5;
                if(sKey==='fix30') val=fmt(m30); else if(sKey==='gra') val=fmt(mGra); else if(sKey==='mga') val=fmt(mMga); else val=fmt(m30>mGra?m30:mGra);
            }
            if(z.id === "plag") {
                if(sKey==='mga') val = fmt(data.alot16 + ((data.tzais16-data.alot16)/12)*10.75);
                else val = fmt(rise + ((set-rise)/12)*10.75);
            }
            if(z.id === "candles") {
                if(status.isFri || status.isErev) val = fmt(setShkia - mins(parseInt(sKey)));
                else val = "--:--";
            }
            if(z.id === "tzais") {
                if(status.isShab) val = fmt(sKey==='8.5' ? data.tzais85 : setShkia+mins(parseInt(sKey)));
                else val = fmt(sKey==='8.5' ? data.tzais85 : setShkia+mins(parseInt(sKey)));
            }
            if(z.id === "shaa") {
                let ms = sKey==='gra' ? (set-rise)/12 : (data.tzais16-data.alot16)/12;
                val = (ms/60000).toFixed(1);
                sub = "min";
            }

            let selectHTML = "";
            if(z.opts) {
                selectHTML = `<select class="card-select" onchange="changeOption('${z.id}', this.value)">
                    ${z.opts.map(o => `<option value="${o[0]}" ${sKey===o[0]?'selected':''}>${o[1]}</option>`).join('')}
                </select>`;
            }

            html += `<li class="zman-card">
                <div class="zman-left">
                    <span class="zman-label">${z.label}</span>
                    <span class="zman-desc">${z.desc}</span>
                    ${selectHTML}
                </div>
                <div class="zman-right">
                    <span class="zman-time">${val}</span>
                    ${sub ? `<span class="sub-label">${sub}</span>` : ''}
                </div>
            </li>`;
        });
        document.getElementById('zmanimList').innerHTML = html;
        renderGlossary();
    }

    function renderGlossary() {
        let html = "";
        zmanimConfig.forEach(z => {
            let optsHTML = "";
            if(z.opts) {
                optsHTML = `<div class="glossary-content"><strong>Options:</strong>` + 
                z.opts.map(o => `<div><strong>${o[1]}:</strong> ${getGlossaryDesc(z.id, o[0])}</div>`).join('') + `</div>`;
            }
            html += `<details><summary>${z.label}</summary>${optsHTML || `<div class="glossary-content">${z.desc}</div>`}</details>`;
        });
        document.getElementById('glossaryList').innerHTML = html;
    }

    function getGlossaryDesc(id, optKey) {
        if(id==="mish") {
            if(optKey==='10.2') return "Standard (10.2¬∞ below).";
            if(optKey==='11') return "Earlier (11¬∞).";
            if(optKey==='11.5') return "Earliest (11.5¬∞).";
        }
        if(id==="plag") {
            if(optKey==='gra') return "Standard. 1.25 hours before Sunset.";
            if(optKey==='mga') return "Early. 1.25 MGA hours before Nightfall.";
        }
        if(id==="shaa") {
            if(optKey==='gra') return "Day is Sunrise to Sunset.";
            if(optKey==='mga') return "Day is Dawn (Alos) to Night (Tzais).";
        }
        if(id.includes("shema") || id.includes("tefila")) return optKey==='gra' ? "Sunrise to Sunset" : "Dawn to Nightfall";
        if(id==="alot") return optKey==='16.1' ? "Sun 16.1¬∞ below horizon" : "Fixed minutes before sunrise";
        if(id==="sunrise" || id==="sunset") return optKey==='elev' ? "Top of mountain (Visible)" : "Sea Level (Flat)";
        if(id==="tzais") return optKey==='8.5' ? "Standard (3 Stars)" : `${optKey} mins after sunset`;
        return "";
    }

    function changeOption(key, val) { opts[key] = val; render(); }
    function shiftDate(d) { currentDate.setDate(currentDate.getDate() + d); render(); }
    function goToday() { currentDate = new Date(); document.getElementById('dateModal').classList.remove('active'); render(); }
    function setDateFromPicker() { const v = document.getElementById('datePicker').value; if(v) { currentDate = new Date(v); document.getElementById('dateModal').classList.remove('active'); render(); } }
    function openLocModal() { document.getElementById('locModal').classList.add('active'); }
    function closeLocModal() { document.getElementById('locModal').classList.remove('active'); }
    function openDateModal() { document.getElementById('datePicker').value = currentDate.toISOString().split('T')[0]; document.getElementById('dateModal').classList.add('active'); }

    // Init
    render();
    document.getElementById('locBtn').innerText = `${loc.name} (${loc.elev}m)`;
</script>

</body>
</html>
